<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.presents.issuetracker.issue.mapper.IssueMapper">

    <resultMap id="issueResultMap" type="IssueSearchVo">
        <id property="issueId" column="issue_id"/>
        <result property="title" column="issue_title"/>
        <result property="status" column="issue_status"/>
        <result property="createdAt" column="issue_created_at"/>

        <association property="author" javaType="User">
            <id property="userId" column="author_id"/>
            <result property="loginId" column="author_login_id"/>
            <result property="image" column="author_image"/>
        </association>

        <association property="milestone" javaType="Milestone">
            <id property="milestoneId" column="milestone_id"/>
            <result property="name" column="milestone_name"/>
        </association>

        <collection property="labels" ofType="Label">
            <id property="labelId" column="label_id"/>
            <result property="name" column="label_name"/>
            <result property="textColor" column="label_text_color"/>
            <result property="backgroundColor" column="label_background_color"/>
        </collection>
    </resultMap>

    <select id="getIssues" resultMap="issueResultMap"
            parameterType="org.presents.issuetracker.issue.dto.request.IssueSearchParam">
        SELECT DISTINCT i.issue_id as issue_id,
        i.title as issue_title,
        i.status as issue_status,
        i.created_at as issue_created_at,
        u.user_id as author_id,
        u.login_id as author_login_id,
        u.image as author_image,
        l.label_id as label_id,
        l.name as label_name,
        l.text_color as label_text_color,
        l.background_color as label_background_color,
        m.milestone_id as milestone_id,
        m.name as milestone_name
        FROM issue i
        INNER JOIN user u ON u.user_id = i.author_id
        LEFT OUTER JOIN milestone m ON i.milestone_id = m.milestone_id AND m.status != 'deleted'
        LEFT OUTER JOIN issue_label il ON i.issue_id = il.issue_id
        LEFT OUTER JOIN label l ON il.label_id = l.label_id AND l.is_deleted = false
        LEFT OUTER JOIN assignee a ON i.issue_id = a.issue_id
        LEFT OUTER JOIN user u2 ON a.user_id = u2.user_id
        LEFT OUTER JOIN comment c ON i.issue_id = c.issue_id AND c.is_deleted = false
        LEFT OUTER JOIN user u3 ON c.author_id = u3.user_id
        <where>
            i.status != 'deleted'
            <if test="status != null">
                <trim prefix="AND">
                    i.status = #{status}
                </trim>
            </if>
            <if test="authorName != null">
                <trim prefix="AND">
                    u.login_id = #{authorName}
                </trim>
            </if>
            <if test="labelName != null">
                <trim prefix="AND">
                    l.name = #{labelName}
                </trim>
            </if>
            <if test="milestoneName != null">
                <trim prefix="AND">
                    m.name = #{milestoneName}
                </trim>
            </if>
            <if test="assigneeName != null">
                <trim prefix="AND">
                    u2.login_id = #{assigneeName}
                </trim>
            </if>
            <if test="commentAuthorName != null">
                <trim prefix="AND">
                    u3.login_id = #{commentAuthorName}
                </trim>
            </if>
            <if test="title != null and title.trim() != ''">
                <trim prefix="AND">
                    i.title LIKE CONCAT('%', #{title}, '%')
                </trim>
            </if>
        </where>
    </select>

    <select id="getLabelCount" resultType="Long">
        SELECT COUNT(*)
        FROM label
        WHERE is_deleted = false;
    </select>

    <select id="getMilestoneCount" resultType="Long">
        SELECT COUNT(*)
        FROM milestone
        WHERE status != 'deleted';
    </select>

</mapper>
